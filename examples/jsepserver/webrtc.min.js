var WebRTC=function(l,g){function p(b){return"string"==typeof b&&0<b.length}function f(b,a){if(a)a=Error(a),a.number=b,d.onerror(a);else if("string"==typeof b)d.onerror(Error(b));else d.onerror(b)}function w(){try{var b=new XMLHttpRequest;b.onreadystatechange=function(){if(4==b.readyState&&c){if(200!=b.status)return c._datasets=0,c._trycount++,c._trycount>=R?f(b.status,"http-set failed"):g("ERROR: http-set try "+c._trycount+", status is "+b.status);c._trycount=0;c._data.splice(0,c._datasets);c._datasets=
0;var a=JSON.parse(b.responseText);if(0!=a.ret)return f(a.ret,b.responseText);if(0<c._data.length)return w()}};var a=r+"/v1/set/"+c.confNum+"/"+c.instanceId;g("POST "+a);b.open("POST",a);c._datasets=c._data.length;b.setRequestHeader("Content-type","application/json; charset=utf-8");b.send(JSON.stringify({data:c._data}))}catch(S){return f(S)}}function v(b,a){b.from=t;if(k){if(!a)throw Error("invalid peer");b.to=a;k.send(JSON.stringify(b))}else if(c)b.to=a||c.instanceId,c._data.push(JSON.stringify(b)),
0==c._datasets&&w();else return f("invalid state");b.txt?g("&gt&gt"+b.txt):b.ice&&b.ice.candidate?g("&gt&gt"+b.ice.candidate):g("&gt&gt"+b.type)}function B(b,e){a&&a.dc?a.dc.send(b):v({txt:b,type:"msg"},e)}function C(){a.heart&&clearTimeout(a.heart);for(var b=a.getLocalStreams(),e=0,c=b.length;e<c;++e){for(var h=b[e].getTracks(),u=0,f=h.length;u<f;++u)h[u].stop();if(a.removeStream)try{a.removeStream(b[e])}catch(T){}}if(a.senders)try{for(e=0,c=a.senders.length;e<c;++e)a.removeTrack(a.senders[e])}catch(T){}a.close();
x=a=null;d.share=null;d.update=null;d.mute=null;g("hangup ok")}function D(b){var e=JSON.parse(b);if(!e)return g("invalid msg: "+b);if("msg"==e.type)return d.onmessage(e.txt,e.from);if("cmd"==e.type)g("&lt&lt"+e.txt),"hangup"==e.txt&&a&&(C(),d.onhangup());else{e.ice&&e.ice.candidate?g("&lt&lt"+e.ice.candidate):g("&lt&lt"+e.type);try{if(a||(x=!0,d.oncall(e.from)),a&&(e.ice&&a.addIceCandidate(new RTCIceCandidate(e.ice)),e.sdp)){p(e.shareid)&&(a.remoteStreamTypes[e.shareid]="peershare");var c=new RTCSessionDescription(e.sdp);
a.setRemoteDescription(c,function(){E(c.type,"remote",c)},f)}}catch(h){return f(h)}}}function F(){if(c){try{var a=new XMLHttpRequest;a.onreadystatechange=function(){if(4==a.readyState&&c){if(200!=a.status)g("ERROR: http-get status "+a.status);else{var b=JSON.parse(a.responseText);if(0!=b.ret)return f(b.ret,a.responseText);b=b.data;if(Array.isArray(b)&&0<b.length)for(var d=0,h=b.length;d<h;++d)D(b[d])}c.heart=setTimeout(F,G)}};a.open("GET",r+"/v1/get/"+c.confNum+"/"+c.instanceId);a.send()}catch(e){return f(e)}0==
c._datasets&&0<c._data.length&&w()}}function E(b,e,c){g("set "+b+" into "+e+" ok");"local"==e&&v({sdp:c,type:"sdp",shareid:a.localShareId},a.peer);if("offer"==b&&"remote"==e&&a.localVideoStream)a.onnegotiationneeded()}function H(b){a.setLocalDescription(b,function(){E(b.type,"local",b)},f)}function y(){a&&(v({txt:"hangup",type:"cmd"},a.peer),C())}function I(){y();k&&(k.heart&&clearTimeout(k.heart),k.close(),k=null);if(c){c.heart&&clearTimeout(c.heart);c.abort();var a;c.instanceId&&c.confNum&&(a=r+
"/v1/release/"+c.confNum+"/"+c.instanceId);c=null;if(a){var e=new XMLHttpRequest;e.onreadystatechange=function(){4==e.readyState&&g("http-delete "+(200==e.status?"ok":"failed"))};g("DELETE "+a);e.open("DELETE",a,!0);e.send()}}}function J(b){b.onmessage=function(b){if(a)d.onmessage(b.data,a.peer)};b.onopen=function(){g("dc onopen");a.dc=b};b.onclose=function(){g("dc onclose");a&&(a.dc=null)}}function K(){if(a){a.heart&&clearTimeout(a.heart);a.heart=null;var b=a.signalingState;"have-remote-offer"==
b?a.createAnswer(H,f):"stable"==b?a.createOffer(H,f,{offerToReceiveAudio:!0,offerToReceiveVideo:!0}):"closed"!=b&&"have-local-offer"!=b&&(a.heart=setTimeout(K,1E3))}}function L(){if(a)if(a.localVideoStream){a.dtmf=null;d.dtmf=null;if(0<a.localVideoStream.getVideoTracks().length)d.onremovestream(a.localVideoStream,"localvideo");for(var b=a.getLocalStreams(),c=0,g=b.length;c<g;++c){var h=b[c];if(m!=h){for(var u=h.getTracks(),f=0,k=u.length;f<k;++f){var l=u[f];l.stop();a.localVideoStream.removeTrack(l)}a.removeStream&&
a.removeStream(h)}}if(a.senders){c=0;for(g=a.senders.length;c<g;++c)a.removeTrack(a.senders[c]);a.senders=[]}}else a.localVideoStream=new MediaStream,x||J(a.createDataChannel("data channel"))}function U(b,c){if(a)for(var e=a.getLocalStreams(),h=0,d=e.length;h<d;++h){for(var g=e[h].getAudioTracks(),f=0,k=g.length;f<k;++f)g[f].enabled=!b;g=e[h].getVideoTracks();f=0;for(k=g.length;f<k;++f)g[f].enabled=!c}}function M(b){if(a){L();if(a.removeStream)a.addStream(b);else{a.senders=[];var c=b.getTracks();
var f=c.length;for(h=0;h<f;++h)a.senders.push(a.addTrack(c[h],b))}f=b.getAudioTracks();0<f.length&&(a.dtmf=a.getSenders?a.getSenders()[0].dtmf:a.createDTMFSender(f[0]),a.dtmf&&(a.dtmf.ontonechange=function(a){g("dtmf: "+a.tone)},d.dtmf=function(b,c,h){a&&a.dtmf&&a.dtmf.insertDTMF(b,c,h)}));b=b.getVideoTracks();f=b.length;if(0<f){for(h=0;h<f;++h)a.localVideoStream.addTrack(b[h]);d.onaddstream(a.localVideoStream,"localvideo")}a.onnegotiationneeded()}else{c=b.getTracks();var h=0;for(f=c.length;h<f;++h)c[h].stop()}}
function N(b){if("object"==typeof b){if("function"==typeof b.getTracks&&"function"==typeof b.getAudioTracks&&"function"==typeof b.getVideoTracks){g("media object: "+b);M(b);return}if(b.audio||b.video){g("media constraints: "+JSON.stringify(b));navigator.mediaDevices.getUserMedia(b).then(M).catch(f);return}}g("media closed");L();if(a)a.onnegotiationneeded()}function z(b,e,f){if("function"!=typeof d.onaddstream)throw Error("invalid onaddstream");if("function"!=typeof d.onremovestream)throw Error("invalid onremovestream");
!b&&c&&c.config&&(b=c.config);if("object"!=typeof b)throw Error("invalid call arguments");g("call "+JSON.stringify(b));a=new RTCPeerConnection(b);a.peer=f;a.localShareId="";a.remoteStreamTypes={};a.onicecandidate=function(b){b&&b.candidate&&a&&v({ice:b.candidate,type:"ice",shareid:a.localShareId},f)};a.onaddstream=function(b){if(a){var c=a.remoteStreamTypes[b.stream.id];c||(c=0<b.stream.getVideoTracks().length?"peervideo":0<b.stream.getAudioTracks().length?"peeraudio":"peerdata",a.remoteStreamTypes[b.stream.id]=
c);d.onaddstream(b.stream,c)}};a.onremovestream=function(b){if(a){var c=a.remoteStreamTypes[b.stream.id];c&&(delete a.remoteStreamTypes[b.stream.id],d.onremovestream(b.stream,c))}};a.oniceconnectionstatechange=function(a){a=a.currentTarget.iceConnectionState;g("ICE:"+a);if(d.oniceconnectionstatechange)d.oniceconnectionstatechange(a)};a.onsignalingstatechange=function(a){a=a.currentTarget.signalingState;g("signaling:"+a);if(d.onsignalingstatechange)d.onsignalingstatechange(a)};a.ondatachannel=function(a){J(a.channel)};
a.onnegotiationneeded=function(){a&&!a.heart&&(a.heart=setTimeout(K,1E3))};N(e);d.share=V;d.update=N;d.mute=U}function V(b){a&&(b?m&&a.localShareId!=m.id?(a.localShareId=m.id,a.addStream(m),d.onaddstream(m,"localshare")):W(function(b,c,h){if(a){if(b){if(d.onremovestream)d.onremovestream(m,"localshare");return g(b)}m||navigator.mediaDevices.getUserMedia(h).then(function(b){m=b;b.getVideoTracks()[0].onended=function(){m=null;if(a&&a.localShareId==b.id){a.removeStream(b);if(d.onremovestream)d.onremovestream(b,
"localshare");a.localShareId=""}};if(a&&(a.localShareId=b.id,a.addStream(b),d.onaddstream))d.onaddstream(m,"localshare")}).catch(f)}}):m&&a.localShareId==m.id&&(a.removeStream(m),d.onremovestream(m,"localshare"),a.localShareId=""))}function X(a){n?a():(n=document.createElement("iframe"),n.onload=function(){n.isLoaded=!0;a()},n.src=O,n.style.display="none",(document.body||document.documentElement).appendChild(n))}function A(){n?n.isLoaded?n.contentWindow.postMessage({captureSourceId:!0},"*"):setTimeout(A,
100):X(A)}if(!this||this==window)return"17120702";if("object"!=typeof l)throw Error("invalid config");var O="https://www.webrtc-experiment.com/getSourceId/",t=l.id,r=l.url,R=l.__HTTP_RETRY__||3,G=l.__HTTP_INTERVAL__||1E3;l.getsourceid&&0==l.getsourceid.indexOf("https://")&&(O=l.getsourceid);p(t)||(t=Math.random().toString(36).substr(2,4));g||(g=console.debug);var a,x,d=this;d.onerror=console.error;if(0==r.indexOf("ws://")){try{var k=new WebSocket(r)}catch(b){return null}k.onerror=function(a){if(k)return f("websocket failed")};
k.onopen=function(){g("ws onopen");k.send(JSON.stringify({from:t}));k.heart&&clearTimeout(k.heart);k.heart=null;d.call=z;d.send=B;d.onopen(t)};k.onmessage=function(a){D(a.data)};k.onclose=function(a){k&&(g("ws onclose"),d.call=d.send=null,d.onclose())};k.heart=setTimeout(function(){return f("ws timeout")},1E4)}else if(0==r.indexOf("http")&&"object"==typeof l.confProps)try{var q=l.confProps;if(!p(q.roomId))throw Error("invalid confProps.roomId");if(!p(q.accountName))throw Error("invalid confProps.accountName");
if(!p(q.password))throw Error("invalid confProps.password");if(!p(q.appKey))throw Error("invalid confProps.appKey");if(!p(q.regionId))throw Error("invalid confProps.regionId");var P=r+"/v1/conference/"+q.roomId;delete q.roomId;var Q=JSON.stringify(q);var c=new XMLHttpRequest;c._data=[];c._datasets=0;c._trycount=0;c.onreadystatechange=function(){if(c&&4==c.readyState){if(200!=c.status)return f(c.status,"http-conference failed");var a=JSON.parse(c.responseText);if(0!=a.ret)return f(a.ret,c.responseText);
if(!p(a.data.instanceId))return f("invalid instanceId");if(!p(a.data.confNum))return f("invalid confNum");g("http onopen");c.confNum=a.data.confNum;d.call=z;d.send=B;c.config=a.data;c.instanceId=a.data.instanceId;d.onopen(t,a.data);delete c.config.confNum;delete c.config.instanceId;c.heart=setTimeout(F,G)}};c.open("POST",P);c.setRequestHeader("Content-type","application/json; charset=utf-8");g("POST "+P+"\n"+Q);l.__TEST_INSTANCE__&&(g("TEST_INSTANCE="+l.__TEST_INSTANCE__),c.setRequestHeader("TEST_INSTANCE",
l.__TEST_INSTANCE__));c.send(Q)}catch(b){throw b;}else throw Error("invalid url");d.close=I;d.hangup=y;d.onopen=g;d.onclose=I;d.oncall=z;d.onhangup=y;d.onmessage=g;var m,n,W=function(a){function b(c){if(c.data){if(c.data.chromeMediaSourceId)if("PermissionDeniedError"===c.data.chromeMediaSourceId)a("permission-denied");else{var d=c.data.chromeMediaSourceId;c=c.data.chromeMediaSourceId;var e={audio:!1,video:{mandatory:{chromeMediaSource:"desktop",maxWidth:1920<window.screen.width?window.screen.width:
1920,maxHeight:1080<window.screen.height?window.screen.height:1080},optional:[]}};c&&(e.video.mandatory.chromeMediaSourceId=c);a(null,d,e)}window.removeEventListener("message",b)}}navigator.mozGetUserMedia?a(null,"firefox",{video:{mozMediaSource:"window",mediaSource:"window"}}):(window.addEventListener("message",b),setTimeout(A,100))}};
